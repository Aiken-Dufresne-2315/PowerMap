# 动态网格构建与悬挂顶点定位技术方案

## 一、技术目标与问题描述

经过顶点对齐优化后，电网拓扑图中的大部分节点已位于辅助线交叉点上，但仍存在两类问题：

第一，某些节点距所有聚类中心都超过容差范围，未能被对齐，称为**悬挂顶点（Dangling Vertices, DV）**，其存在破坏了网格结构的完整性。第二，辅助线集合在对齐阶段静态确定，无法适应悬挂顶点定位时可能出现的新需求。

本技术方案提出动态网格（Dynamic Grid）系统，能够基于对齐后的节点坐标构建初始辅助线集合，并在定位过程中动态扩展。在此基础上，采用基于贪心策略的定位算法，系统性地将悬挂顶点移至辅助线交叉点，完成网格化布局。

## 二、动态网格构建技术

### 2.1 基于投票机制的辅助线提取

动态网格构建的核心是从对齐后的节点坐标中提取辅助线。进一步采用投票机制而非聚类的优势在于能直接获取每条辅助线上的节点列表。

遍历所有节点 $v_i$ 的坐标 $(x_i, y_i)$，对于纵坐标 $y_i$，检查是否存在候选坐标 $\hat{y} \in \mathcal{Y}$ 满足 $|y_i - \hat{y}| \leq \tau$（$\tau$ 为投票容差）。若存在则累加投票，否则创建新候选。形式化地：

$$
c(\hat{y}_j) = \left|\left\{ v_i : |y_i - \hat{y}_j| \leq \tau \right\}\right|
$$

引入最小投票阈值 $\theta_{\min}$，水平辅助线集合定义为：

$$\mathcal{H} = \left\{ h_j = (\hat{y}_j, V_j) : c(\hat{y}_j) \geq \theta_{\min} \right\}$$

其中 $V_j$ 为投票给 $\hat{y}_j$ 的节点集合。垂直辅助线集合 $\mathcal{V}$ 的定义类似，按位置升序排列。

### 2.2 辅助线的动态扩展

当悬挂顶点无法移至现有辅助线交叉点时，在其当前位置引入新辅助线。添加新线 $h_{\text{new}}$ 时需检查重复性（$|\hat{y}_j - y_{\text{new}}| < \epsilon_{\text{dup}}$），若无重复则插入并维护有序性。定位完成后，重新扫描所有节点更新辅助线的节点集合 $V_j$。

## 三、悬挂顶点的识别与分类

交叉点集合定义为 $\mathcal{I} = \{ (\hat{x}_k, \hat{y}_j) : v_k \in \mathcal{V}, h_j \in \mathcal{H} \}$。节点 $v_i$ 的坐标为 $(x_i, y_i)$，若不存在交叉点 $(x^*, y^*) \in \mathcal{I}$ 使得 $|x_i - x^*| < \epsilon$ 且 $|y_i - y^*| < \epsilon$，则称其为悬挂顶点。

悬挂顶点分为两类：**部分悬挂顶点（PDV）**在一个方向上已对齐但另一方向未对齐；**完全悬挂顶点（FDV）**在两个方向上均未对齐。按度数降序处理悬挂顶点，优先固定关键枢纽节点位置。

## 四、相邻辅助线查找与顺序一致性

对于悬挂节点 $v_i$（坐标 $(x_i, y_i)$），其相邻辅助线定义了可移动到的候选交叉点。查找需满足**顺序一致性约束**：若在 $v_i$ 与某条辅助线之间存在其他悬挂节点，则不可将 $v_i$ 移到该辅助线上，以避免节点之间的相对位置关系被破坏。

设水平辅助线按位置升序排列为 $\hat{y}_1 < \hat{y}_2 < \cdots < \hat{y}_p$。对于 $v_i$ 的纵坐标 $y_i$：

- 若 $y_i > \hat{y}_p$，初始候选集合为 $\{h_p\}$，检查 $v_i$ 与 $h_p$ 之间是否存在其他同列悬挂节点。若存在则从候选集合中移除被阻塞的候选辅助线 $h_p$，即候选集合为空集；否则候选集合为 $\{h_p\}$。
- 若 $\hat{y}_{j-1} < y_i < \hat{y}_j$，初始候选集合为 $\{h_{j-1}, h_j\}$，分别检查 $v_i$ 与各候选线之间是否存在同列悬挂节点，移除被阻塞的候选辅助线。
- 若 $y_i < \hat{y}_1$，检查 $h_1$ 与 $v_i$ 之间是否存在阻塞，用类似方式确定候选集合。

最终得到可用相邻线集合 $\mathcal{A}_H(v_i)$，垂直方向 $\mathcal{A}_V(v_i)$ 的查找逻辑是完全对称的。若得到空集，则需在当前位置添加新的水平或垂直辅助线。

## 五、悬挂顶点定位算法

定义重叠检测谓词 $\Omega(v, p)$：节点 $v$ 移至位置 $p$ 是否产生几何重叠，返回真则表示重叠。

### 5.1 部分悬挂顶点（PDV）定位

PDV已在一个方向上对齐，只需在另一方向调整。以在水平线 $h_j$ 上但不在任何垂直线上的PDV为例：

获取相邻垂直线集合 $\mathcal{A}_V(v_i)$。对每条垂直线 $v_k \in \mathcal{A}_V(v_i)$，候选位置为 $p_k = (\hat{x}_k, y_i)$。在所有满足 $\Omega(v_i, p_k) = \text{false}$ 的候选中，选择距离最近的：

$$p^* = \arg\min_{p_k : \neg\Omega(v_i, p_k)} |x_i - \hat{x}_k|$$

若存在可行位置 $p^*$，则移动 $v_i$ 到 $p^*$；否则，在 $x_i$ 处添加新垂直辅助线。

### 5.2 完全悬挂顶点（FDV）定位

FDV需在两个方向调整，采用分步策略：

**垂直定位**：获取 $\mathcal{A}_V(v_i)$，对每条 $v_k$，候选位置 $p_k = (\hat{x}_k, y_i)$（保持纵坐标）。选择最近无重叠位置移动，或在 $x_i$ 处添加新垂直线。

**水平定位**：基于更新后的横坐标，获取 $\mathcal{A}_H(v_i)$，对每条 $h_j$，候选位置 $p_j = (x_i, \hat{y}_j)$（保持横坐标）。选择最近无重叠位置移动，或在 $y_i$ 处添加新水平线。

### 5.3 定位主流程与性质

识别所有悬挂顶点并按度数降序排序。依次处理每个悬挂顶点：先处理所有PDV，再处理所有FDV。每次定位后立即更新图和辅助线集合。完成后重新扫描所有顶点，更新辅助线的顶点集合。

算法具有以下性质：（1）**完备性**：动态添加辅助线保证所有悬挂顶点最终位于交叉点；（2）**无重叠性**：$\Omega$ 检测确保布局合法；（3）**贪心最优性**：每步选择最近可行位置；（4）**顺序一致性**：相邻线查找的阻塞检测避免顶点间相对位置冲突。

## 六、数据流与执行流程

**输入**：顶点对齐后的节点坐标、线路列表、图拓扑（来自顶点对齐模块）

**执行流程**：
1. 基于投票机制构建辅助线集合 $\mathcal{H}, \mathcal{V}$
2. 识别不在交叉点的悬挂顶点，按度数降序排列
3. 依次定位PDV和FDV，必要时动态添加辅助线
4. 更新节点坐标、线路角度，重建顶点-线映射关系

**输出**：更新后的节点坐标、扩展后的辅助线集合（传递给间距优化模块）

## 七、关键技术参数与性能

**关键参数**：
- 投票容差 $\tau = 2.315$：与对齐精度匹配
- 最小投票数 $\theta_{\min} = 2.0$：避免噪声形成辅助线
- 位置匹配精度 $\epsilon = 10^{-2}$：判定节点在线上或交叉点
- 重复检测精度 $\epsilon_{\text{dup}} = 10^{-9}$：避免浮点误差

**复杂度**：网格构建 $O(n^2)$（实际近似线性），悬挂顶点识别 $O(n \cdot p \cdot q)$，定位 $O(|\mathcal{D}| \cdot (p+q+n+m))$。对于百级节点规模，总运行时间通常1-3秒。实验表明，该方法能将所有悬挂顶点定位到合法的交叉点，新增辅助线1-5条，网格覆盖率达100%。

