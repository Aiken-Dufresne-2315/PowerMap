# 顶点对齐优化技术方案

## 一、问题与目标

经过线路方向正交化后，输电线路已基本对齐到水平或垂直方向，但节点位置仍较分散。本模块通过将节点对齐到水平和垂直辅助线上，形成网格化布局，提升拓扑图的规整性和可读性。

核心问题：（1）确定辅助线的数量和位置；（2）在避免重叠的前提下将节点分配到辅助线上。

## 二、数学模型

### 2.1 问题定义

设图为 \(G=(V,E)\)，节点 \(v_i\) 的当前坐标为 \((x_i, y_i)\)，优化后坐标为 \((X_i, Y_i)\)。目标是找到水平辅助线集 \(\mathcal{H} = \{h_1, \ldots, h_p\}\) 和垂直辅助线集 \(\mathcal{V} = \{v_1, \ldots, v_q\}\)，使大部分节点对齐到辅助线交叉点上。

定义节点到辅助线的距离：

\[d_H(v_i, h_j) = |y_i - h_j|, \quad d_V(v_i, v_k) = |x_i - v_k|\]

当 \(d_H(v_i, h_j) \leq \tau\) 或 \(d_V(v_i, v_k) \leq \tau\) 时（\(\tau\) 为对齐容差），节点可对齐到对应辅助线。

### 2.2 优化目标与约束

**目标函数**：最小化节点坐标偏移的加权平方和

\[\min \sum_{i=1}^{n} w_i \left[(X_i - x_i)^2 + (Y_i - y_i)^2\right]\]

其中 \(w_i\) 为节点权重（当前实现中统一为1.0，可扩展为基于度数的权重）。

**约束条件**：

1. **强制对齐约束**：若节点 \(v_i\) 需对齐到水平线 \(h_j\)，则 \(Y_i = h_j\)；若对齐到垂直线 \(v_k\)，则 \(X_i = v_k\)。

2. **坐标边界**：\(X_{\min} \leq X_i \leq X_{\max}, \quad Y_{\min} \leq Y_i \leq Y_{\max}\)

## 三、基于K-means聚类的辅助线发现

### 3.1 一维K-means聚类

辅助线发现问题建模为一维K-means聚类。给定坐标序列 \(C = \{c_1, \ldots, c_n\}\)（横坐标或纵坐标），目标是划分为 \(k\) 个簇，最小化簇内平方和（WCSS）：

\[\text{WCSS}(k) = \sum_{j=1}^{k} \sum_{c_i \in S_j} (c_i - \mu_j)^2\]

聚类中心 \(\{\mu_1, \ldots, \mu_k\}\) 即为辅助线位置。

**算法流程**：

1. **初始化**：对坐标序列排序去重得 \(C' = \{c'_1, \ldots, c'_m\}\)，均匀选取 \(k\) 个初始中心：
   \[\mu_j^{(0)} = c'_{\lfloor (j-1) \cdot \frac{m-1}{k-1} \rfloor}, \quad j = 1, \ldots, k\]

2. **迭代**（最多50次，收敛阈值 \(\epsilon_{\text{conv}} = 10^{-6}\)）：
   - **分配步**：将每个点分配到最近的中心
   - **更新步**：重新计算簇中心为簇内点的均值

### 3.2 最优聚类数自适应确定

采用肘部法则（Elbow Method）确定最优 \(k\)。搜索范围：

\[k \in [1, k_{\max}], \quad k_{\max} = \min\left\{ \left\lfloor \frac{m}{k_{\min}} \right\rfloor, \left\lfloor \sqrt{m} \right\rfloor + 2 \right\}\]

其中 \(k_{\min}\) 为最小簇大小。对每个候选 \(k\)，计算评分：

\[\text{Score}(k) = \text{WCSS}(k) + \lambda_{\text{penalty}} \cdot k\]

选择评分最小的 \(k^* = \arg\min_{k} \text{Score}(k)\)。WCSS项度量簇紧密度，惩罚项抑制过多聚类。

**输出**：分别对横、纵坐标聚类，得到辅助线集 \(\mathcal{H}, \mathcal{V}\)。

## 四、基于贪心过滤的对齐候选筛选

### 4.1 预选择

对每个节点 \(v_i\)，搜索容差 \(\tau\) 内最近的辅助线：

\[h^*(v_i) = \arg\min_{h_j \in \mathcal{H}} d_H(v_i, h_j), \quad \text{若 } d_H(v_i, h^*(v_i)) \leq \tau\]

\[v^*(v_i) = \arg\min_{v_k \in \mathcal{V}} d_V(v_i, v_k), \quad \text{若 } d_V(v_i, v^*(v_i)) \leq \tau\]

生成候选集 \(\mathcal{C} = \{(i, j, \alpha, d)\}\)，其中 \(\alpha \in \{H, V\}\) 表示方向，\(d\) 为距离。

### 4.2 贪心过滤算法

为避免重叠，采用贪心过滤策略：

**步骤**：

1. **分组**：按辅助线分组候选集 \(\mathcal{C}\)。

2. **排序**：每组内按距离 \(d\) 升序排序（距离越小优先级越高）。

3. **逐个尝试对齐**：
   - 计算对齐后新位置：若 \(\alpha = H\)，则 \((x_i', y_i') = (x_i, h_j)\)；若 \(\alpha = V\)，则 \((x_i', y_i') = (v_j, y_i)\)。
   - 调用重叠检测函数检查：节点-节点重叠、节点-线路重叠、线路-线路重叠。
   - 若无重叠，则加入有效集 \(\mathcal{C}_{\text{valid}}\)，并**立即更新图状态**（坐标和线路角度）。
   - 若有重叠，则跳过该候选。

**关键**：即时更新确保后续检测能感知已对齐节点的影响，避免冲突累积。

**输出**：有效候选集 \(\mathcal{C}_{\text{valid}}\)，保证无重叠。

## 五、实现流程

**阶段1：辅助线发现**
- 提取横、纵坐标集合 \(\{x_i\}, \{y_i\}\)。
- 对纵坐标聚类得 \(\mathcal{H}\)，对横坐标聚类得 \(\mathcal{V}\)。
- 若无辅助线，跳过优化。

**阶段2：候选筛选**
- 预选择：为每个节点搜索容差内最近辅助线，生成 \(\mathcal{C}\)。
- 贪心过滤：按辅助线分组，距离排序，逐个尝试对齐并检测重叠，得 \(\mathcal{C}_{\text{valid}}\)。
- 若无有效候选，跳过优化。

**阶段3：优化求解**
- 构建二次规划模型：创建变量 \(X_i, Y_i\)，添加强制对齐约束（\(\mathcal{C}_{\text{valid}}\)中的候选）。
- 调用Gurobi求解器。
- 更新节点坐标、图结构和线路角度。

**阶段4：可视化输出**
- 生成SVG格式电网拓扑图。

## 六、关键参数

| 参数 | 符号 | 取值 | 说明 |
|------|------|------|------|
| 对齐容差 | \(\tau\) | 20.0 | 节点到辅助线的最大距离 |
| 最小簇大小 | \(k_{\min}\) | 3 | K-means每个簇的最小点数 |
| 聚类惩罚系数 | \(\lambda_{\text{penalty}}\) | 50.0 | 肘部法则评分中的惩罚项系数 |
| 收敛阈值 | \(\epsilon_{\text{conv}}\) | \(10^{-6}\) | K-means迭代收敛判定阈值 |
| 最大迭代次数 | - | 50 | K-means最大迭代轮数 |
| 节点权重 | \(w_i\) | 1.0 | 目标函数中的节点权重（当前统一值） |

## 七、复杂度分析

- **K-means聚类**：搜索 \(k_{\max} = O(\sqrt{m})\) 个候选，每个最多迭代50次，单次迭代 \(O(m \cdot k)\)，总复杂度 \(O(m^2)\)。
- **预选择**：\(O(n \cdot (p + q))\)，其中 \(p, q\) 为辅助线数量，通常5-15条。
- **贪心过滤**：\(O(|\mathcal{C}| \cdot T_{\text{overlap}})\)，其中 \(|\mathcal{C}| = O(n)\)，\(T_{\text{overlap}} = O(n + m)\)，总复杂度 \(O(n \cdot (n + m))\)。
- **优化求解**：变量数 \(2n\)，约束数 \(O(|\mathcal{C}_{\text{valid}}|)\)，求解时间秒级（百级节点）。
