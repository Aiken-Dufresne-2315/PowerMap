# 边方向正交化优化技术方案

## 一、问题与目标

电网线路图的可读性要求线路尽可能沿水平或垂直方向布局。本模块通过调整节点坐标，使线路方向对齐到正交轴，同时避免线路重叠和过度偏离原始布局。

## 二、数学模型

### 2.1 问题定义

设电网拓扑为无向图 \(G=(V,E)\)，其中 \(V=\{v_1, \ldots, v_n\}\) 为节点集（变电站/配电节点），\(E=\{e_1, \ldots, e_m\}\) 为线路集。节点 \(v_i\) 的原始坐标为 \((x_i, y_i)\)，优化后坐标为 \((X_i, Y_i)\)。

线路 \(e_{ij}\) 的方向角通过 `atan2` 计算并归一化到 \([0, 2\pi)\)：

\[\theta_{ij} = \mathrm{atan2}(y_j - y_i, x_j - x_i) \mod 2\pi, \quad \theta \in [0, 2\pi)\]

定义线路到对齐轴的角度偏移为：

\[\Delta_V(\theta) = \min\{|\theta - \frac{\pi}{2}|, |\theta - \frac{3\pi}{2}|\} \quad \text{(垂直轴)}\]

\[\Delta_H(\theta) = \min\{|\theta|, |\theta - \pi|, |\theta - 2\pi|\} \quad \text{(水平轴)}\]

当 \(\Delta_V(\theta) \leq \delta\) 或 \(\Delta_H(\theta) \leq \delta\) 时（\(\delta\) 为角度阈值），线路被认为接近对应轴。

### 2.2 优化目标与约束

**目标函数**：最小化节点坐标偏移的平方和

\[\min \sum_{i=1}^{n} \left[(X_i - x_i)^2 + (Y_i - y_i)^2\right]\]

**约束条件**：

1. ##### **条件正交约束**（Big-M方法）：引入布尔标志 \(v_{ij}, h_{ij}\) 表示线路是否需要对齐，未对齐线路的约束通过 Big-M 松弛：

   \[X_i - X_j \leq \epsilon + M(1 - v_{ij}), \quad X_j - X_i \leq \epsilon + M(1 - v_{ij})\]
   \[Y_i - Y_j \leq \epsilon + M(1 - h_{ij}), \quad Y_j - Y_i \leq \epsilon + M(1 - h_{ij})\]

2. **坐标边界**：\(X_{\min} \leq X_i \leq X_{\max}, \quad Y_{\min} \leq Y_i \leq Y_{\max}\)

## 三、线路方向分配算法

### 3.1 核心问题

直接对所有接近轴方向的线路施加对齐约束会导致严重的线路重叠问题。以一个三条线路方向均接近竖直方向的形状狭长的三角形为例，若直接对其三条线路施加方向约束，则会导致优化后的三条线路彼此重合，从而传达了错误的拓扑关系，严重违反了布局优化的原则。为解决类似的线路重叠问题，可以采用以下的算法流程。

### 3.2 算法流程

**初始化**：  

1. 对所有线路初始化对齐状态：\(s_V(e) = -1, s_H(e) = -1\)（-1表示未处理，0表示不对齐，1表示对齐）。  
2. 按节点度数降序排序，得到处理序列 \(\{v_{\pi(1)}, \ldots, v_{\pi(n)}\}\)。

**主循环**（对每个节点 \(v_{\pi(k)}\) 和每个对齐轴 \(\alpha \in \{V, H\}\)）：

1. **遍历相邻线路** \(e_{ij}\)（\(v_i = v_{\pi(k)}\)）：
   - 若 \(s_\alpha(e_{ij}) \neq -1\)（即该条边已处理），则跳过。
   - 若 \(\Delta_\alpha(\theta_{ij}) > \delta\)（即该边不在角度邻域内），则标记 \(s_\alpha(e_{ij}) = 0\)（不在角度邻域内）。
   - 否则，检查另一端点 \(v_j\) 是否已有对齐到 \(\alpha\) 的线路：
     - 若 \(v_j\) 的任一相邻线路 \(e_{jk}\) 满足 \(s_\alpha(e_{jk}) = 1\)，则标记 \(s_\alpha(e_{ij}) = 0\)（避免冲突）。
     - 否则，标记 \(s_\alpha(e_{ij}) = 1\)（候选对齐）。

2. **筛选当前节点的对齐线路**：
   - 收集当前节点在轴 \(\alpha\) 上所有状态为1的线路：\(C_\alpha = \{e : s_\alpha(e) = 1\}\)。
   - 若 \(|C_\alpha| > 1\)，选择角度偏移最小的线路 \(e^* = \arg\min_{e \in C_\alpha} \Delta_\alpha(\theta_e)\)，将其他线路重新标记为0。

**输出**：垂直对齐线路集 \(E_V = \{e : s_V(e) = 1\}\) 和水平对齐线路集 \(E_H = \{e : s_H(e) = 1\}\)。

### 3.3 算法性质

- **无重叠性**：任一节点在每个轴上至多有一条对齐线路。
- **局部最优性**：在无冲突的前提下，优先选择角度偏移最小的线路。
- **高优先级优先**：度数高的节点优先处理，提升关键节点的对齐质量。

## 四、实现流程

1. **计算坐标边界**：从原始坐标中提取 \(X_{\min}, X_{\max}, Y_{\min}, Y_{\max}\)。
2. **构建决策变量**：为每个节点创建连续变量 \(X_i, Y_i\)，初值设为原始坐标。
3. **执行线路方向分配**：按上述算法确定 \(E_V, E_H\)。
4. **添加约束**：为 \(E_V, E_H\) 中的线路添加对齐约束，为所有线路添加 Big-M 条件约束。
5. **求解优化模型**：调用 Gurobi 求解器。
6. **更新坐标与角度**：将优化结果写回节点列表和线路列表，重新计算线路的方向角。

## 五、关键参数

| 参数 | 符号 | 取值 | 说明 |
|------|------|------|------|
| 角度阈值 | \(\delta\) | 30° | 判定线路是否接近正交的角度容差 |
| 对齐容差 | \(\epsilon\) | 10e-3 | 对齐约束的精度要求（0表示严格对齐） |
| Big-M常数 | \(M\) | 1000.0 | 条件约束松弛系数，需远大于坐标范围 |

## 六、复杂度分析

- **预处理**：节点排序 \(O(n \log n)\)，线路遍历 \(O(m)\)。
- **优化求解**：变量数 \(2n\)，约束数 \(O(m)\)，求解时间在秒级（百级节点规模）。
- **对齐覆盖率**：通常 50%-70% 的角度邻域内线路被纳入对齐集合。
