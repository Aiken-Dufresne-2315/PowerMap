# 辅助线间距均匀化技术方案

## 一、问题背景与研究动机

电网拓扑图的网格化布局依赖于一组水平和垂直的辅助线。这些辅助线的位置经过一系列处理流程确定：首先通过K-means聚类从节点坐标分布中识别初始位置，随后经过选举机制对辅助线集合加以补充，最后通过DVP（Dangling Vertex Positioning）算法对节点在辅助线上的具体位置进行优化，并视情况添加新的辅助线。经过这一完整流程后，节点已成功对齐到辅助线交叉点上，形成了规整的网格结构。

然而，由于辅助线位置源自数据驱动的聚类过程，其间距往往呈现不规则分布。某些区域的辅助线密集排列，而另一些区域则稀疏分布，这种不均匀性会影响拓扑图的整体视觉美感。从视觉感知的角度来看，人类对均匀分布的几何结构具有天然的偏好。在电网拓扑图设计领域，均匀的网格间距能够传递出规整、有序的视觉信息，使读者更容易把握拓扑图的空间尺度，并有助于节点间距离的直观比较。

本模块的核心挑战在于：如何在维持首尾辅助线位置不变（以保持整体布局范围）、保证相邻辅助线满足最小间距要求（以避免视觉拥挤）的约束下，通过调整中间辅助线的位置，使所有相邻间距尽可能接近均匀分布。这一问题本质上是一个带有等式和不等式约束的二次优化问题。

## 二、问题的数学表述

### 2.1 基本定义与符号约定

设存在 \(k\) 条辅助线（水平或垂直），其当前位置按升序排列为 \(\{p_1, p_2, \ldots, p_k\}\)，满足 \(p_1 < p_2 < \cdots < p_k\)。优化的目标是找到一组新的位置 \(\{P_1, P_2, \ldots, P_k\}\)，使得相邻辅助线的间距 \(d_i = P_{i+1} - P_i\) 尽可能均匀。

定义理想间距（target spacing）为辅助线总范围的均分：

\[s_{\text{target}} = \frac{p_k - p_1}{k - 1}\]

该定义基于一个直观原则：在固定的总范围内，若要使 \(k\) 条线等间距分布，则相邻间距应等于总长度除以间隔数。这一理想间距为后续优化提供了参考基准。

需要注意的是，当辅助线数量过多或总范围过小时，可能出现 \(s_{\text{target}} < s_{\min}\) 的情况，其中 \(s_{\min}\) 为预设的最小间距阈值。此时，严格的均匀分布将导致辅助线过于密集，影响视觉效果。因此，算法在此情况下将目标间距修正为 \(s_{\text{target}} := s_{\min}\)，以最小间距为准。

### 2.2 优化模型的构建

基于上述定义，可将辅助线间距均匀化问题形式化为如下约束优化模型：

**决策变量**：\(P_1, P_2, \ldots, P_k \in \mathbb{R}\)，表示优化后的辅助线位置。

**目标函数**：最小化各间距与理想间距的偏差平方和

\[\min f(P_1, \ldots, P_k) = \sum_{i=1}^{k-1} (P_{i+1} - P_i - s_{\text{target}})^2\]

该目标函数具有明确的几何意义：每一项 \((P_{i+1} - P_i - s_{\text{target}})^2\) 度量了第 \(i\) 个间距与理想间距的偏离程度，平方形式使得较大的偏差受到更严厉的惩罚。通过最小化所有偏差的平方和，优化过程倾向于使各间距尽可能接近理想值，从而实现整体的均匀分布。从数学角度看，这是一个凸二次规划问题，保证了全局最优解的存在性和唯一性。

**约束条件**：

1. **边界固定约束**：
   \[P_1 = p_1, \quad P_k = p_k\]
   
   该约束确保辅助线的总体范围不变。固定首尾位置的设计有两个考量：首先，保持已有站点的整体布局不发生显著变形；其次，避免引入额外的自由度导致优化问题欠约束。在实践中，首尾辅助线往往对应着地图边缘区域，其位置的稳定性对保持地图的整体结构至关重要。

2. **顺序与最小间距约束**：
   \[P_i + s_{\min} \leq P_{i+1}, \quad i = 1, 2, \ldots, k-1\]
   
   该约束同时保证了两个性质：首先，辅助线的相对顺序不变（\(P_i < P_{i+1}\)）；其次，任意相邻辅助线的间距不小于预设的最小值 \(s_{\min}\)。最小间距约束的引入避免了辅助线过度靠近导致的视觉拥挤，同时为站点的空间分布预留了足够的余地。在数学上，这一不等式约束使优化问题转化为凸二次规划（Convex Quadratic Programming, QP）问题。

3. **位置边界约束**：
   \[p_1 \leq P_i \leq p_k, \quad i = 1, 2, \ldots, k\]
   
   该约束确保所有辅助线位于原始范围内，防止优化过程中出现越界情况。

值得注意的是，上述模型为凸二次规划问题，目标函数为二次凸函数，所有约束均为线性约束，因此必然存在全局最优解，且可通过成熟的优化算法高效求解。

## 三、基于二次规划的求解算法

### 3.1 算法框架与实现

本模块采用商业优化求解器Gurobi求解上述二次规划问题。Gurobi是一款业界领先的数学规划求解器，对凸二次规划问题具有高效的求解性能，采用内点法或单纯形法进行优化。算法的整体框架如下：

**输入**：当前辅助线位置序列 \(\{p_1, \ldots, p_k\}\)，最小间距 \(s_{\min}\)

**输出**：优化后辅助线位置序列 \(\{P_1, \ldots, P_k\}\)

**步骤**：

1. **数据预处理**：对辅助线按位置升序排序，计算总范围 \(R = p_k - p_1\) 和理想间距 \(s_{\text{target}} = R / (k-1)\)。若 \(s_{\text{target}} < s_{\min}\)，发出警告并设 \(s_{\text{target}} := s_{\min}\)。

2. **模型构建**：创建决策变量 \(P_i \in [p_1, p_k]\)，设初值为 \(p_i\)（提供良好的求解起点）。构建目标函数的二次表达式：
   \[f = \sum_{i=1}^{k-1} [(P_{i+1} - P_i) - s_{\text{target}}]^2\]
   
   添加约束：\(P_1 = p_1\)，\(P_k = p_k\)，\(P_i + s_{\min} \leq P_{i+1}\) （\(i = 1, \ldots, k-1\)）。

3. **优化求解**：调用Gurobi求解器的二次规划接口进行求解。凸二次规划问题保证了在有限步内收敛到全局最优解。

4. **结果提取**：从求解器中提取最优解 \(\{P_1^*, \ldots, P_k^*\}\)，计算优化后的间距 \(\{d_1^*, \ldots, d_{k-1}^*\}\) 和目标函数值。

### 3.2 算法的理论保证

凸二次规划的理论性质和Gurobi的算法实现保证了求解的有效性。在实践中，对于辅助线数量在10-20条的典型规模，求解时间通常在毫秒级，远快于其他优化阶段。此外，当输入位置发生小扰动时，最优解的变化是连续且有界的，这保证了算法对前序处理阶段微小波动的鲁棒性。

## 四、坐标更新与系统集成

### 4.1 节点坐标的传播更新

辅助线位置优化完成后，需要同步更新对齐在这些辅助线上的节点坐标。这一过程采用基于映射的批量更新策略：

对于水平辅助线，构建位置映射 \(\phi: p_i \mapsto P_i^*\)。遍历所有节点，若节点纵坐标 \(y\) 满足 \(|y - p_i| < \epsilon\)（\(\epsilon\) 为匹配容差），则更新为 \(y' = P_i^*\)。垂直辅助线的处理类似，作用于横坐标。

该更新策略的关键在于容差 \(\epsilon\) 的设定。过小的 \(\epsilon\) 可能导致浮点误差影响匹配精度，而过大的 \(\epsilon\) 则可能误将非对齐节点纳入更新。实践中，\(\epsilon = 0.01\) 在保证精度的同时具有良好的鲁棒性。

节点坐标更新后，所有关联线路的方向角需要重新计算，对每条线路 \(e_{ij}\) 根据端点新坐标重新计算：
\[\theta_{ij}' = \text{atan2}(y_j' - y_i', x_j' - x_i') \mod 2\pi\]

这一更新确保了后续模块（如重叠检测、可视化等）能够基于正确的几何信息进行处理。

### 4.2 重叠检测与质量评估

辅助线位置调整可能引入新的几何重叠。模块在优化完成后执行全局重叠检测，检查所有节点与非关联线路的位置关系。若检测到节点位于某条线路的内部（不包括端点），则标记为重叠，并在可视化中以红色高亮显示，提示后续人工干预或进一步优化。

这一检测机制为整个优化流程提供了质量保证，确保生成的拓扑图在几何上的合法性。

## 五、参数配置与复杂度分析

### 5.1 关键参数

| 参数 | 符号 | 取值 | 说明 |
|------|------|------|------|
| 最小间距 | \(s_{\min}\) | 10.0 | 基于站点图标尺寸和视觉舒适度确定 |
| 位置匹配容差 | \(\epsilon\) | 0.01 | 平衡浮点精度与匹配准确性 |

### 5.2 算法复杂度

本模块的计算瓶颈在于两个环节：

**二次规划求解**：理论复杂度为 \(O(k^3)\)，其中 \(k\) 为辅助线数量。然而，由于 \(k\) 通常在5-15之间，且Gurobi采用了高度优化的内点法实现，实际求解时间远小于理论上界，通常在毫秒级完成。

**重叠检测**：当前复杂度为 \(O(n \cdot m)\)，其中 \(n\) 为节点数，\(m\) 为线路数。

综合来看，在包含100个节点、10条辅助线的典型案例中，模块总运行时间约1-2秒。优化后，辅助线间距标准差通常降低60%-80%，视觉均匀性显著提升。
